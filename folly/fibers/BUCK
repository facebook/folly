load("@fbcode_macros//build_defs:auto_headers.bzl", "AutoHeaders")
load("@fbcode_macros//build_defs:build_file_migration.bzl", "fbcode_target", "non_fbcode_target")
load("@fbcode_macros//build_defs:cpp_library.bzl", "cpp_library")
load("@fbsource//tools/build_defs/dirsync:fb_dirsync_cpp_library.bzl", "fb_dirsync_cpp_library")
load("../defs.bzl", "folly_xplat_library")

oncall("fbcode_entropy_wardens_folly")

fb_dirsync_cpp_library(
    name = "add_tasks",
    headers = [
        "AddTasks.h",
        "AddTasks-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        "//folly:optional",
        "//folly:try",
    ],
)

fb_dirsync_cpp_library(
    name = "atomic_batch_dispatcher",
    headers = [
        "AtomicBatchDispatcher.h",
        "AtomicBatchDispatcher-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        "//folly:c_portability",
        "//folly:function",
        "//folly:optional",
        "//folly/fibers/detail:atomic_batch_dispatcher",
        "//folly/futures:core",
    ],
)

fb_dirsync_cpp_library(
    name = "batch_dispatcher",
    headers = ["BatchDispatcher.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        "//folly:function",
        "//folly/futures:core",
    ],
)

fb_dirsync_cpp_library(
    name = "batch_semaphore",
    srcs = ["BatchSemaphore.cpp"],
    headers = ["BatchSemaphore.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":semaphore_base",
    ],
)

fb_dirsync_cpp_library(
    name = "boost_context_compatibility",
    headers = ["BoostContextCompatibility.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        "fbsource//third-party/glog:glog",
        "//folly:function",
    ],
    exported_external_deps = [
        ("boost", None, "boost_context"),
    ],
)

non_fbcode_target(
    _kind = folly_xplat_library,
    name = "core",
    srcs = [
        "Baton.cpp",
        "Fiber.cpp",
        "FiberManager.cpp",
    ],
    raw_headers = [
        "Baton.h",
        "Baton-inl.h",
        "Fiber.h",
        "Fiber-inl.h",
        "FiberManagerInternal.h",
        "FiberManagerInternal-inl.h",
        "Promise.h",
        "Promise-inl.h",
    ],
    deps = [
        "fbsource//xplat/folly/portability:asm",
        "fbsource//xplat/folly/portability:config",
        "fbsource//xplat/folly/portability:sys_syscall",
        "fbsource//xplat/folly/portability:unistd",
        "fbsource//xplat/folly/synchronization:sanitize_thread",
        "//third-party/glog:glog",
        "//xplat/folly:constexpr_math",
        "//xplat/folly:singleton_thread_local",
        "//xplat/folly/detail:memory_idler",
        "//xplat/folly/memory:sanitize_address",
    ],
    exported_deps = [
        "//xplat/folly:atomic_linked_list",
        "//xplat/folly:c_portability",
        "//xplat/folly:executor",
        "//xplat/folly:function",
        "//xplat/folly:intrusive_list",
        "//xplat/folly:likely",
        "//xplat/folly:memory",
        "//xplat/folly:optional",
        "//xplat/folly:portability",
        "//xplat/folly:scope_guard",
        "//xplat/folly:try",
        "//xplat/folly/detail:futex",
        "//xplat/folly/executors:execution_observer",
        "//xplat/folly/experimental/coro:coroutine",
        "//xplat/folly/fibers:boost_context_compatibility",
        "//xplat/folly/fibers:guard_page_allocator",
        "//xplat/folly/fibers:loop_controller",
        "//xplat/folly/fibers:traits",
        "//xplat/folly/functional:invoke",
        "//xplat/folly/io/async:async_base",
        "//xplat/folly/io/async:request_context",
        "//xplat/folly/lang:thunk",
        "//xplat/folly/tracing:async_stack",
    ],
)

fbcode_target(
    _kind = cpp_library,
    name = "core",
    srcs = [
        "Baton.cpp",
        "Fiber.cpp",
        "FiberManager.cpp",
    ],
    auto_headers = AutoHeaders.NONE,
    headers = [
        "Baton.h",
        "Baton-inl.h",
        "Fiber.h",
        "Fiber-inl.h",
        "FiberManagerInternal.h",
        "FiberManagerInternal-inl.h",
        "Promise.h",
        "Promise-inl.h",
    ],
    deps = [
        "fbsource//third-party/glog:glog",
        "//folly:constexpr_math",
        "//folly:singleton_thread_local",
        "//folly/detail:memory_idler",
        "//folly/memory:sanitize_address",
        "//folly/portability:asm",
        "//folly/portability:config",
        "//folly/portability:sys_syscall",
        "//folly/portability:unistd",
        "//folly/synchronization:sanitize_thread",
    ],
    exported_deps = [
        ":boost_context_compatibility",
        ":guard_page_allocator",
        ":loop_controller",
        ":traits",
        "//folly:atomic_linked_list",
        "//folly:c_portability",
        "//folly:executor",
        "//folly:function",
        "//folly:intrusive_list",
        "//folly:likely",
        "//folly:memory",
        "//folly:optional",
        "//folly:portability",
        "//folly:scope_guard",
        "//folly:try",
        "//folly/coro:coroutine",
        "//folly/detail:async_trace",
        "//folly/detail:futex",
        "//folly/executors:execution_observer",
        "//folly/functional:invoke",
        "//folly/io/async:async_base",
        "//folly/io/async:request_context",
        "//folly/lang:thunk",
        "//folly/portability:pthread",
        "//folly/tracing:async_stack",
    ],
)

fb_dirsync_cpp_library(
    name = "core_manager",
    headers = [
        "FiberManager.h",
        "FiberManager-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        "//folly/functional:invoke",
        "//folly/futures:core",
    ],
)

fb_dirsync_cpp_library(
    name = "event_base_loop_controller",
    headers = [
        "EventBaseLoopController.h",
        "EventBaseLoopController-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        ":executor_based_loop_controller",
        "//folly:cancellation_token",
        "//folly:memory",
        "//folly/io/async:async_base",
    ],
)

fb_dirsync_cpp_library(
    name = "executor_based_loop_controller",
    headers = ["ExecutorBasedLoopController.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":loop_controller",
        "//folly:executor",
    ],
)

fb_dirsync_cpp_library(
    name = "executor_loop_controller",
    headers = [
        "ExecutorLoopController.h",
        "ExecutorLoopController-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        ":executor_based_loop_controller",
        "//folly:executor",
        "//folly:scope_guard",
        "//folly/futures:core",
    ],
)

fb_dirsync_cpp_library(
    name = "fiber_manager_map",
    headers = [
        "FiberManagerMap.h",
        "FiberManagerMap-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        ":event_base_loop_controller",
        "//folly:function",
        "//folly:scope_guard",
        "//folly:singleton_thread_local",
        "//folly:synchronized",
        "//folly/container:f14_hash",
        "//folly/io/async:async_base",
        "//folly/synchronization:relaxed_atomic",
    ],
)

fb_dirsync_cpp_library(
    name = "fibers",
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":add_tasks",  # @manual
        ":atomic_batch_dispatcher",  # @manual
        ":batch_dispatcher",  # @manual
        ":batch_semaphore",  # @manual
        ":boost_context_compatibility",  # @manual
        ":core",  # @manual
        ":core_manager",  # @manual
        ":event_base_loop_controller",  # @manual
        ":fiber_manager_map",  # @manual
        ":for_each",  # @manual
        ":generic_baton",  # @manual
        ":guard_page_allocator",  # @manual
        ":loop_controller",  # @manual
        ":semaphore",  # @manual
        ":semaphore_base",  # @manual
        ":simple_loop_controller",  # @manual
        ":timed_mutex",  # @manual
        ":traits",  # @manual
        ":when_n",  # @manual
    ],
)

fb_dirsync_cpp_library(
    name = "for_each",
    headers = [
        "ForEach.h",
        "ForEach-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        "//folly/functional:invoke",
    ],
)

fb_dirsync_cpp_library(
    name = "generic_baton",
    headers = ["GenericBaton.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        "//folly/synchronization:baton",
    ],
)

fb_dirsync_cpp_library(
    name = "guard_page_allocator",
    srcs = ["GuardPageAllocator.cpp"],
    headers = ["GuardPageAllocator.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    deps = [
        "fbsource//third-party/glog:glog",
        "//folly:singleton",
        "//folly:spin_lock",
        "//folly:synchronized",
        "//folly/portability:sys_mman",
        "//folly/portability:unistd",
    ],
    external_deps = [
        ("glibc", None, "dl"),
    ],
)

fb_dirsync_cpp_library(
    name = "loop_controller",
    headers = ["LoopController.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        "//folly/io/async:async_base_fwd",
    ],
)

fb_dirsync_cpp_library(
    name = "semaphore",
    srcs = ["Semaphore.cpp"],
    headers = ["Semaphore.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        "//folly:intrusive_list",
        "//folly:synchronized",
        "//folly/coro:task",
        "//folly/coro:timeout",
        "//folly/futures:core",
    ],
)

fb_dirsync_cpp_library(
    name = "semaphore_base",
    srcs = ["SemaphoreBase.cpp"],
    headers = ["SemaphoreBase.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        "//folly:intrusive_list",
        "//folly:synchronized",
        "//folly/coro:task",
        "//folly/futures:core",
    ],
)

fb_dirsync_cpp_library(
    name = "simple_loop_controller",
    srcs = ["SimpleLoopController.cpp"],
    headers = ["SimpleLoopController.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    deps = [
        "//folly/io/async:async_base",
    ],
    exported_deps = [
        ":core_manager",
        ":loop_controller",
        "//folly:function",
        "//folly:likely",
    ],
)

fb_dirsync_cpp_library(
    name = "timed_mutex",
    headers = [
        "CallOnce.h",
        "TimedMutex.h",
        "TimedMutex-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":generic_baton",
        "//folly:intrusive_list",
        "//folly:portability",
        "//folly:spin_lock",
        "//folly/synchronization:call_once",
        "//folly/synchronization/detail:sleeper",
    ],
)

fb_dirsync_cpp_library(
    name = "traits",
    headers = ["traits.h"],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
)

fb_dirsync_cpp_library(
    name = "when_n",
    headers = [
        "WhenN.h",
        "WhenN-inl.h",
    ],
    use_raw_headers = True,
    xplat_impl = folly_xplat_library,
    exported_deps = [
        ":core",
        ":for_each",
        "//folly:optional",
        "//folly/functional:invoke",
    ],
)
